---
summary: 'Clawnet refactor: unify network protocol, roles, auth, approvals, identity'
read_when:
  - Planning a unified network protocol for nodes + operator clients
  - 'Reworking approvals, pairing, TLS, and presence across devices'
---
# Clawnet 重构（协议 + 认证统一）

## 欢迎
嗨，Peter——方向很棒；这将带来更简洁的用户体验和更强的安全性。

## 目的
一份全面而严谨的文档，涵盖以下内容：
- 当前状态：协议、流程、信任边界。
- 痛点：审批、多跳路由、UI 重复。
- 提议的新状态：单一协议、作用域角色、统一认证/配对、TLS 固定。
- 身份模型：稳定 ID + 可爱别名。
- 迁移计划、风险及待解决的问题。

## 目标（来自讨论）
- 所有客户端使用同一协议（mac 应用、CLI、iOS、Android、无头节点）。
- 网络中的每个参与者都经过认证并完成配对。
- 角色清晰：节点与操作员。
- 中央审批路由到用户所在位置。
- 所有远程流量均采用 TLS 加密，并可选择固定证书。
- 代码重复最小化。
- 单一设备应仅显示一次（避免 UI/节点条目重复）。

## 非目标（明确说明）
- 不取消能力隔离（仍需遵循最小权限原则）。
- 不在不进行作用域检查的情况下暴露完整的网关控制平面。
- 认证不依赖于人类标签（别名与安全性无关）。

---

# 当前状态（现状）

## 两种协议

### 1) 网关 WebSocket（控制平面）
- 完整的 API 表面：配置、通道、模型、会话、代理运行、日志、节点等。
- 默认绑定：环回。通过 SSH/Tailscale 实现远程访问。
- 认证：通过 `connect` 使用令牌或密码。
- 无 TLS 固定（依赖环回/隧道）。
- 代码：
  - `src/gateway/server/ws-connection/message-handler.ts`
  - `src/gateway/client.ts`
  - `docs/gateway/protocol.md`

### 2) 桥接协议（节点传输）
- 狭窄的白名单表面，涉及节点身份与配对。
- 基于 TCP 的 JSONL；可选 TLS + 证书指纹固定。
- TLS 在发现 TXT 中公布指纹。
- 代码：
  - `src/infra/bridge/server/connection.ts`
  - `src/gateway/server-bridge.ts`
  - `src/node-host/bridge-client.ts`
  - `docs/gateway/bridge-protocol.md`

## 当前控制平面客户端
- CLI → 网关 WS，通过 `callGateway` (`src/gateway/call.ts`)。
- macOS 应用 UI → 网关 WS (`GatewayConnection`)。
- Web 控制 UI → 网关 WS。
- ACP → 网关 WS。
- 浏览器控制使用其自己的 HTTP 控制服务器。

## 当前节点
- macOS 应用以节点模式连接到网关桥接协议 (`MacNodeBridgeSession`)。
- iOS/Android 应用连接到网关桥接协议。
- 配对信息和每节点令牌存储在网关中。

## 当前审批流程（执行）
- 代理通过网关调用 `system.run`。
- 网关通过桥接协议调用节点。
- 节点运行时决定是否批准。
- macOS 应用显示 UI 提示（当节点与 macOS 应用同机时）。
- 节点将 `invoke-res` 返回给网关。
- 多跳路由，UI 与节点主机绑定。

## 当前存在感与身份
- 网关存在条目来自 WS 客户端。
- 节点存在条目来自桥接协议。
- macOS 应用可能为同一台机器显示两个条目（UI + 节点）。
- 节点身份存储在配对存储中；UI 身份独立存储。

---

# 问题 / 痛点

- 需维护两个协议栈（WS + 桥接）。
- 远程节点上的审批：提示出现在节点主机上，而不是用户所在位置。
- TLS 固定仅适用于桥接协议；WS 依赖 SSH/Tailscale。
- 身份重复：同一台机器显示为多个实例。
- 角色模糊：UI、节点和 CLI 的功能未明确区分。

---

# 提议的新状态（Clawnet）

## 单一协议，两种角色
单一 WS 协议，支持角色与作用域。
- **角色：节点**（能力宿主）
- **角色：操作员**（控制平面）
- 操作员可选 **作用域**：
  - `operator.read`（状态与查看）
  - `operator.write`（代理运行、发送）
  - `operator.admin`（配置、通道、模型）

### 角色行为

**节点**
- 可注册能力（`caps`、`commands`、权限）。
- 可接收 `invoke` 命令（`system.run`、`camera.*`、`canvas.*`、`screen.record` 等）。
- 可发送事件：`voice.transcript`、`agent.request`、`chat.subscribe`。
- 不能调用配置/模型/通道/会话/代理控制平面 API。

**操作员**
- 全功能控制平面 API，受作用域限制。
- 接收所有审批。
- 不直接执行 OS 操作；将请求路由至节点。

### 关键规则
角色是按连接定义的，而非按设备定义的。一台设备可以同时打开这两种角色，但彼此独立。

---

# 统一认证 + 配对

## 客户端身份
每个客户端提供：
- `deviceId`（稳定，由设备密钥派生）。
- `displayName`（人类名称）。
- `role` + `scope` + `caps` + `commands`。

## 配对流程（统一）
- 客户端以未认证状态连接。
- 网关为该 `deviceId` 创建一个 **配对请求**。
- 操作员收到提示；批准或拒绝。
- 网关颁发与以下内容绑定的凭证：
  - 设备公钥
  - 角色
  - 作用域
  - 能力/命令
- 客户端保存令牌，重新连接时已认证。

## 设备绑定认证（避免承载令牌重放）
首选：设备密钥对。
- 设备一次性生成密钥对。
- `deviceId = fingerprint(publicKey)`。
- 网关发送随机数；设备签名；网关验证。
- 令牌颁发给公钥（证明持有权），而非字符串。

替代方案：
- mTLS（客户端证书）：最安全，但运维复杂度更高。
- 短暂的承载令牌仅作为临时阶段（提前轮换 + 吊销）。

## 静默审批（SSH 启发式）
精确定义以避免成为薄弱环节。优先选择以下方式：
- **仅限本地**：当客户端通过环回/Unix 套接字连接时自动配对。
- **通过 SSH 挑战**：网关发出随机数；客户端通过获取随机数来证明 SSH。
- **物理存在窗口**：在网关主机 UI 上进行本地批准后，允许在短时间内（如 10 分钟）自动配对。

始终记录并存档自动批准。

---

# TLS 无处不在（开发 + 生产）

## 复用现有桥接 TLS
使用当前的 TLS 运行时和指纹固定：
- `src/infra/bridge/server/tls.ts`
- 指纹验证逻辑位于 `src/node-host/bridge-client.ts`

## 应用于 WS
- WS 服务器支持使用相同证书/密钥和指纹的 TLS。
- WS 客户端可以选择固定指纹。
- 发现服务为所有端点宣传 TLS 和指纹。
  - 发现服务仅提供定位提示，绝非信任锚点。

## 为什么
- 减少对 SSH/Tailscale 在保密性方面的依赖。
- 使远程移动连接默认安全。

---

# 审批重新设计（集中化）

## 当前
审批发生在节点主机上（macOS 应用节点运行时）。提示出现在节点运行的位置。

## 提议
审批由 **网关托管**，UI 提示传递给操作员客户端。

### 新流程
1) 网关收到 `system.run` 意图（代理）。
2) 网关创建审批记录： `approval.requested`。
3) 操作员 UI 显示提示。
4) 审批决定发送至网关： `approval.resolve`。
5) 如果获批，网关调用节点命令。
6) 节点执行，并返回 `invoke-res`。

### 审批语义（强化）
- 广播给所有操作员；只有活动的 UI 显示模态框（其他 UI 显示通知）。
- 第一次决议获胜；网关拒绝后续决议，视为已解决。
- 默认超时：N 秒后拒绝（例如 60 秒），并记录原因。
- 决议需要 `operator.approvals` 作用域。

## 益处
- 提示出现在用户所在位置（mac/手机）。
- 远程节点的审批更加一致。
- 节点运行时保持无头状态；不再依赖 UI。

---

# 角色清晰化示例

## iPhone 应用
- **节点角色**：麦克风、摄像头、语音聊天、位置、一键通话。
- 可选 **operator.read** 用于状态和聊天视图。
- 可选 **operator.write/admin** 仅在显式启用时可用。

## macOS 应用
- 默认为操作员角色（控制 UI）。
- 当启用“Mac 节点”时为节点角色（系统运行、屏幕、摄像头）。
- 两个连接使用相同的 deviceId → UI 条目合并。

## CLI
- 始终为操作员角色。
- 作用域由子命令派生：
  - `status`、`logs` → read
  - `agent`、`message` → write
  - `config`、`channels` → admin
  - 审批 + 配对 → `operator.approvals` / `operator.pairing`

---

# 身份 + 别名

## 稳定 ID
认证所需；永不改变。
首选：
- 密钥对指纹（公钥哈希）。

## 可爱别名（龙虾主题）
仅供人类标签。
- 示例：`scarlet-claw`、`saltwave`、`mantis-pinch`。
- 存储在网关注册表中，可编辑。
- 冲突处理：`-2`、`-3`。

## UI 分组
同一 `deviceId` 跨角色 → 单一行“实例”：
- 徽章：`operator`、`node`。
- 显示功能 + 最后一次出现时间。

---

# 迁移策略

## 阶段 0：文档化 + 对齐
- 发布本文档。
- 清点所有协议调用和审批流程。

## 阶段 1：在 WS 中添加角色/作用域
- 扩展 `connect` 参数，加入 `role`、`scope`、`deviceId`。
- 为节点角色添加白名单限制。

## 阶段 2：桥接兼容性
- 保留桥接协议运行。
- 同时增加 WS 的节点支持。
- 将功能置于配置标志后。

## 阶段 3：中央审批
- 在 WS 中添加审批请求和决议事件。
- 更新 macOS 应用 UI 以显示提示并响应。
- 节点运行时停止显示 UI 提示。

## 阶段 4：TLS 统一
- 为 WS 添加 TLS 配置，使用桥接 TLS 运行时。
- 在客户端中添加指纹固定。

## 阶段 5：弃用桥接协议
- 将 iOS/Android/mac 节点迁移到 WS。
- 保留桥接协议作为后备；一旦稳定即移除。

## 阶段 6：设备绑定认证
- 要求所有非本地连接使用基于密钥的身份。
- 添加吊销 + 轮换 UI。

---

# 安全注意事项

- 角色/白名单在网关边界强制执行。
- 任何客户端在没有操作员作用域的情况下都无法获得“完整”API。
- *所有*连接都需要配对。
- TLS + 固定降低了移动端的中间人攻击风险。
- SSH 静默审批是一种便利措施；但仍会被记录并可撤销。
- 发现服务绝不是信任锚点。
- 功能声明由平台/类型根据服务器白名单进行验证。

# 流媒体 + 大型负载（节点媒体）
WS 控制平面适合小消息，但节点还处理：
- 摄像头片段
- 屏幕录制
- 音频流

选项：
1) WS 二进制帧 + 分块 + 背压规则。
2) 独立的流媒体端点（仍需 TLS + 认证）。
3) 为处理大量媒体的命令，继续使用桥接协议，最后再迁移。

在实施前选择一种方案，以避免偏离。

# 功能 + 命令政策
- 节点报告的功能/命令被视为 **声明**。
- 网关根据平台白名单强制执行。
- 任何新命令都需要操作员批准或显式白名单变更。
- 使用时间戳审计变更。

# 审计 + 速率限制
- 日志：配对请求、审批/拒绝、令牌签发/轮换/吊销。
- 限制配对垃圾信息和审批提示的频率。

# 协议规范
- 明确协议版本 + 错误码。
- 重连规则 + 心跳策略。
- 存在 TTL 和最后一次出现语义。

---

# 待解决问题

1) 单一设备同时运行两种角色：令牌模型
   - 建议为每种角色使用单独的令牌（节点 vs 操作员）。
   - 同一 deviceId；不同作用域；吊销更清晰。

2) 操作员作用域的粒度
   - read/write/admin + 审批 + 配对（最低可行）。
   - 后期可考虑按功能细化作用域。

3) 令牌轮换 + 吊销的用户体验
   - 在角色变化时自动轮换。
   - 提供按 deviceId + 角色吊销的 UI。

4) 发现服务
   - 扩展现有的 Bonjour TXT，加入 WS TLS 指纹 + 角色提示。
   - 仅将其视为定位提示。

5) 跨网络审批
   - 广播给所有操作员客户端；活动 UI 显示模态框。
   - 第一次响应获胜；网关强制执行原子性。

---

# 总结（简短版）

- 当前：WS 控制平面 + 桥接节点传输。
- 痛点：审批、重复、双协议栈。
- 提议：单一 WS 协议，具有明确的角色与作用域，统一配对与 TLS 固定，网关托管审批，稳定设备 ID + 可爱别名。
- 结果：更简洁的用户体验、更强的安全性、更少的重复、更好的移动路由。
